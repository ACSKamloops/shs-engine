# Action Log — Pukaist Engine

- 2025-12-15: Expanded Codex-in-web control and observability: added a new `/admin → Codex Hub` panel (Codex version/feature flags, session resume runner, repo review runner, optional JSON event streaming + cancel), extended backend Codex streaming to support `--output-last-message` for cleaner persisted chat replies and `json_events` SSE mode, and aligned defaults toward local-first providers (Wizard labels now use “Legacy template” instead of “Legal”, Codex admin default model set to `llama3.2`). Also fixed pytest hanging in socket-restricted sandboxes by installing `uvloop` in `tests/conftest.py`. Validation: `python3 -m pytest -q` and `npm -C frontend run build`.
- 2025-12-15: Neutralized user-facing onboarding and geo UX to be domain-agnostic: updated the workspace wizard and header to use neutral “project/workspace” language (workflow templates, stakeholder fields, goal wording, focus areas) instead of case/claims framing; switched mission-based geo suggestions to call the live `/mission/geo_suggest` API when available; reframed the “consultation” panel and map drop feedback as “geo context” with non-advisory copy and explicit verification note; refreshed the Codex Chat prefill prompt to request “verbatim excerpts” instead of “evidence per agents.md”, and updated `.env.example` + `frontend/index.html` copy to remove “legal-grade/court” phrasing. Validation: `npm --prefix frontend run build` and `npm --prefix frontend run test:unit`.
- 2025-12-04: Refined evidence review UX in the workspace: expanded the inspector’s source panel with a clearer multi-page PDF hint and a one-click “Open full” button that launches the browser’s native viewer, adjusted the Artifact panel to open on OCR by default when no summary exists (for faster side-by-side verification), and added concise per-document review state chips plus aggregate review counts in the Documents list so users can quickly see which records are Not started, In scope (unreviewed), Reviewed, Needs follow-up, or Deferred without leaving the main workspace. Frontend builds remain green via `npm run build`.
- 2025-12-04: Added demo evidence assets and a loader script: seeded `docs/demo` with six themed demo files plus `demo_manifest.json` (covering land, governance, water, coercion, privilege, and map pins), and added `scripts/load_demo.py` that uploads, polls for processed docs, and applies labels/review/coords via the API (run with API/worker active). The Basic-mode “Getting started” strip now includes a “Load demo data (instructions)” button that surfaces the CLI command (`python -m scripts.load_demo`). This gives a quick, local-first way to showcase themes, map pins, and review chips without real data.
- 2025-12-04: Extended project profiles with advanced requirements and theme summaries: added a `requirements_notes` field to `ProjectConfig` and wired a new “Advanced requirements (optional)” textarea into the full project wizard’s pipeline step so onboarding can capture constraints like archive priorities, handling of privileged material, or LLM limits without changing how evidence is stored; also surfaced per-view legal theme counts in the Documents panel using existing `breach_category` and `THEME_LABELS` so users can see how many in-scope docs relate to Land reduction, Governance, Water rights, etc., plus an overall reviewed/needs-follow-up summary in the Project focus card. Frontend continues to build via `npm run build`.
- 2025-12-04: Smoothed the workspace “basic mode” into a guided home view and surfaced embedding status: added a `GET /embeddings/status` helper so the UI can report whether semantic search is actually enabled (and which KaLM model is configured) without exposing env vars, wired that into the Settings modal as a small “Semantic search” indicator when developer tools are on, and introduced a lightweight “Getting started” strip for basic mode that walks users through 1) defining a project via the wizard, 2) uploading evidence, and 3) reviewing docs on the map/inspector; advanced affordances (Ask, bundles, ops view, dev tools) remain in Advanced mode, keeping first-run UX closer to a guided wizard while preserving all existing functionality. Frontend builds continue to pass via `npm run build`; backend tests still require `pytest` to be installed in this environment.
- 2025-12-04: Completed the Ask-the-archive wiring with clickable sources and verified the KaLM embedding helpers: extended the React Ask panel so semantic queries now capture `/ask` results into `askResults` and render them as a “Sources” list of clickable documents that jump straight into the workspace inspector (reusing `loadPipeline`), kept the existing keyword-only fallback intact for when embeddings are disabled, and ensured the KaLM embedding stack remains runnable locally via `scripts/kalm_embedding_server.py` (4/8-bit quantization) and `scripts/backfill_embeddings.py`; frontend builds cleanly with `npm run build` and a backend test run via `make test` currently fails only because `pytest` is not installed in this environment (no project tests were modified).
- 2025-12-04: Hardened the new Workspace app and added first-class LLM helpers for bundles and Q&A: fixed React runtime/TDZ issues in `App.tsx` (the `api` helper and collection filters now initialize before dependent hooks), wired the inspector’s source preview through the relaxed `/docs/{id}/file` embed endpoint, and cleaned up TypeScript warnings so `npm run build` passes; introduced a `/llm/bundle_draft` API that assembles a bundle outline from selected docs (stable IDs, themes, summaries, and forensic key quotes when present) with a local heuristic draft and optional LLM condense step, and hooked it into the Bundles panel so the “Use AI draft” toggle now calls the backend before falling back to the local outline; added a `/ask` API that reuses FTS/KaLM hybrid search to answer archive questions with a short, local-first markdown answer plus result rows, and updated the Ask-the-archive panel so enabling semantic mode hits `/ask` (with graceful fallback to the existing keyword scorer if the backend or embeddings are unavailable); refreshed the MapControls story and Jobs list types to keep Storybook and TS builds clean for local UI iteration; backend tests currently fail in this environment due to `src` not being on `PYTHONPATH`, but no test code was modified.
- 2025-12-04: Tightened the onboarding wizard and evidence inspector to better match the PESS methodology: enriched the four-step project wizard with step-by-step guidance (case profile, mission, AOI/band focus, pipeline & themes) so users understand that profiles steer behaviour (period, themes, map focus) without moving evidence, and added a compact “Evidence card” to the pipeline inspector showing stable ID, provenance, truncated SHA-256, derived evidence status (Not started / In scope / Ready / Deferred) from relevance/review labels, and forensic reliability/entity counts, giving each document a clear, legal-grade snapshot without opening the full artifact JSON or forensic tab; kept all changes local-only and verified the frontend still builds cleanly via `npm run build`.
- 2025-12-04: Added optional forensic enrichment and semantic search: extended worker artifacts/index with stable IDs, sha256, provenance, theme/breach, reliability, privilege, key evidence quote, and entities (all nullable and off by default), added a forensic LLM pass (guarded by `PUKAIST_LLM_FORENSIC_ENABLED`) that populates those fields under a Clerk-Standard-style prompt, surfaced forensic data in the inspector (new tab) and document list (chips and key-quote preview), added optional Findings & Bundles UI for verified docs (JSON/CSV export and local/AI bundle drafts), introduced an Ask-the-Archive panel with keyword search plus a semantic toggle that hits a new `/search?semantic=true` path, wired a KaLM-based embedding client (`tencent/KaLM-Embedding-Gemma3-12B-2511`) via a local `kalm_embedding_server.py` (4/8-bit) and hybrid index, added a configurable KaLM server (MAX_SEQ_LEN/MAX_BATCH_SIZE/QUANTIZATION) and a `scripts/backfill_embeddings.py` helper for existing docs, and kept all advanced features behind simple toggles so non-technical users can stay in a basic mode.
- 2025-12-03: Tightened the geo-aware mission workflow by wiring First Nation office suggestions into the Mission focus bar (we now scan POI band names for mission terms and surface matching offices as clickable chips that pre-fill the `near_band_nbr` filter), added optional project-scoped geo tags in the worker (when a `ProjectConfig` includes AOI themes/codes/names or band numbers, only matching AOIs/offices contribute to `geo_tags` while raw `geo_context` remains unchanged), added a `/mission/geo_suggest` API that scans cached AOIs/POIs for mission-term overlaps and returns suggested AOI themes/codes/names and band numbers, hooked that into the Workspace project wizard via a “Suggest geo defaults from mission” button, made the Geo context panel interactive by letting users click reserves/treaties/SOI regions and nearby band offices to pre-fill AOI/band filters and highlight matching polygons on the map, updated `docs/geo-intel-plan.md` to reflect the new backend scoping and mission/geo wiring, and kept the Workspace layout aligned with the map-first command-center design.
- 2025-12-03: Relaxed auth friction for local development by adding a `PUKAIST_AUTH_DISABLED` switch to `verify_token` (when set to true, the API skips token/JWT checks and treats all requests as the default tenant) so static demos and the React console can talk to the API without `X-API-Key` while you are iterating locally, and added a trivial `/favicon.ico` 204 handler to avoid noisy 404s in browser consoles; security behavior for tests and non-dev environments is unchanged unless the env flag is explicitly set.
- 2025-12-02: Introduced project profiles with mission + geo defaults by extending `ProjectConfig` to store mission_focus and AOI/First Nation office selections, added a `POST /projects` API to create/update configs, and wired a simple “Project” selector and “New from current…” wizard into the Workspace header so users can save and reload their current mission text, theme, and geo filters as reusable local profiles.
- 2025-12-02: Added per-document review status and lightweight evidence collections: extended the docs index with a `review_status` field and a `/docs/{id}/review` API to mark docs as reviewed/needs-follow-up (wired into the Pipeline inspector and Search & Docs pills), introduced a JSON-backed `collections` store with `/collections` and `/collections/{name}/docs/{doc_id}` endpoints, and surfaced a Collections panel in the Pipeline view so users can add the current doc to named collections and see which collections contain it; API tests added for the new project and collection endpoints.
- 2025-12-02: Tightened the map/list/OCR analysis loop: global `/geojson` doc points are now clickable and open the full pipeline for that doc; hovering doc rows highlights their global markers; and the OCR Preview panel shows a local-only OCR quality estimate (high/medium/low) based on text cleanliness/length to help flag poor OCR, especially for older handwritten evidence.
- 2025-12-02: Added a global docs layer toggle in the map controls so users can hide/show the global `/geojson` points independently of the current doc and AOI layers, introduced a Collection filter in Search & Docs so the docs list and relevance stats can be scoped to a named evidence collection (using the collections already stored under `collections.json`), wired a “Flag for re-OCR / review” button into the OCR Preview panel that, when OCR quality is heuristically low, marks the doc as `needs_follow_up` via the existing review status API, surfaced a compact Collections overview in Search & Docs showing all collections with doc counts and click-to-filter behavior, added mission-aware doc highlighting (doc cards now show a “Mission match” pill + Mission filter), and aligned the global map layer with the Collection filter so only docs from the active collection (when set) are rendered as clickable global markers.
 Chronological notes of material changes for auditability. Keep newest entries at the top.

- 2025-12-02: Extended the Mission focus bar to surface spatial hints by scanning AOI and First Nation office names for mission terms and exposing them as clickable “boundary” and “office” pills that pre-fill the new AOI name and band-number filters in Search & Docs; added an AOI-name filter plus a clear “geo filters” control so users can see and reset spatial constraints easily, and updated `docs/geo-intel-plan.md` Phase 4.2 to mark the mission → spatial-hints flow as implemented on the frontend.
- 2025-12-02: Added geo-aware filters to `/search` and `/docs` so results can be constrained by Indigenous/treaty context (AOI theme, AOI code across reserves/treaties/SOI, and nearest First Nation office band number), wired these filters into the Workspace Search & Docs panel as lightweight AOI/Band inputs, and covered them with API tests; extended the geo context helper with a `doc_matches_geo_filters` function and updated `docs/geo-intel-plan.md` Phase 3/4 checkboxes accordingly.
- 2025-12-02: Wired the new `/docs/{id}/geo_context` helper into the Workspace pipeline inspector so each document now shows intersecting Indigenous/treaty boundaries (reserves, land claims, modern treaties, BC SOI) and the nearest First Nation offices in a dedicated Geo context card, refreshed whenever geo points/suggestions change; added focused unit tests for the geometry helpers and nearest-office ranking plus an API test for `/docs/{id}/geo_context`, and updated `docs/geo-intel-plan.md` to mark Phase 1 doc-level geo context as implemented.
- 2025-12-02: Refined the React console into dual modes (Workspace vs Ops) with a map-first workspace layout (left: upload/search, center: map+suggestions, right: source/OCR inspector), increased map/source preview sizes for OCR verification, widened default CORS origins to cover the static demo host/ports (3000/4173/8002) so `docs/web-demo.html` can talk to the local API without manual env tweaks, and added mission-focused OCR highlighting plus user relevance labels that tint map markers when heuristics/LLM scoring or manual labels are present; extended the API/index to store `user_relevance`, filter `/docs` and `/geojson` by label, and updated the Workspace UI with label-aware filters/sorting, per-view relevance stats, a global docs layer toggle, and a one-click JSONL export of all relevant docs currently in view.
- 2025-12-02: Seeded a `Geo/` data cache with authoritative Indigenous/treaty layers (Aboriginal Lands confirmed/modified, Modern Treaties, First Nations locations, BC SOI regions) by downloading upstream SHP/WFS data, converting to GeoJSON, and emitting normalized AOI FeatureCollections under `Geo/aoi` (themes: `ALC_Confirmed`, `ALC_Modified`, `Modern_Treaty`, `First_Nation_Office`, `BC_SOI`); documented sources/licensing in `Geo/README.md` to support local AOI overlays without re-hitting external portals.
- 2025-12-02: Added `docs/geo-layers-plan.md` as a living design document for Indigenous/treaty geo layers (covering data inventory, AOI normalization, backend storage, UI layer toggles, and testing), and refined AOI preprocessing/import to preserve authoritative attributes (reserve/treaty/SOI names and codes) so future tooltips and filters can be accurate rather than generic.
- 2025-12-01: Added OCR drop/poll section to `docs/web-demo.html` so users can drag files, enqueue OCR, and view extracted text/artifacts inline; expanded default allowed extensions to include common images for intake/OCR; documented Hunyuan/pytesseract setup hints in the header note.
- 2025-12-01: Added optional relevancy scoring (heuristic or LLM-backed) with UI badges, PDF-to-image OCR fallback, and a relevancy onboarding wizard (`scripts/relevancy_wizard.py`); refreshed `docs/web-demo.html` styling and surfacing of relevancy results.
- 2025-12-01: Validated Hunyuan OCR via external vLLM (18k max len, 0.6 GPU util), documented the startup/logging command, and confirmed the smoke test succeeds with the sample asset generator.
- 2025-12-01: Polished the embeddable map/search widget with structured doc detail display (title/theme/type/summary), theme filtering, geolocation centering, marker popups, and updated embed docs; lint remains clean.
- 2025-12-01: Improved the upload/search embed widget UX with banners, better error parsing, and button disabling during work; keeps the embed consistent with the map widget styling.
- 2025-12-01: Linked docs and README to the new embeds (`docs/map-embed.html`, `docs/embed-widget.html`) and map embed usage from the minimal embed example.
- 2025-12-01: Added a `make docs-serve` helper (python http.server @8002) and pointed README’s demo section to it for local embed/console previews.
- 2025-12-01: Standardized API error details (structured `detail.message` for upload size/intent/callback and KMZ errors) and added tests for invalid intent, disallowed extensions, KMZ-disabled responses, and oversized uploads.
- 2025-12-01: Surfaced tenant/roles in the console header via `/whoami` with a manual refresh button to aid local multi-tenant testing.
- 2025-12-01: Added a structured error test for invalid callback URLs on upload to keep `/upload` errors consistent.
- 2025-12-01: Added a tenant-scoped geojson test to ensure `/geojson` respects the default tenant when filtering features.
- 2025-12-01: Added Postgres config placeholders (`PUKAIST_DB_DRIVER`, `PUKAIST_DB_URL`) to `.env.example`, documented local-first defaults vs future Postgres in README/local-dev-testing, and noted current status in the persistence migration doc (SQLite-only today).
- 2025-12-01: Exposed DB driver/url in the config loader (`src/config.py`) to align with the Postgres placeholders while keeping SQLite as the default.
- 2025-12-01: Added OCR deps (`pytesseract`, `Pillow`) to `requirements.txt`, documented optional OCR (pytesseract by default; Hunyuan requires extra GPU-heavy deps) in README and local-dev testing, and installed them in the local venv.
- 2025-12-01: Added an OCR smoke script (`scripts/ocr_smoke.py`) to exercise pytesseract or Hunyuan (GPU) and documented the Hunyuan setup steps in `docs/local-dev-testing.md`.
- 2025-12-01: Added an OCR sample asset generator (`scripts/make_ocr_sample.py`) and wired Hunyuan OCR to optionally call an external OpenAI-compatible vLLM endpoint via `PUKAIST_HUNYUAN_OCR_BASE_URL`/`PUKAIST_HUNYUAN_OCR_API_KEY` instead of in-process loading.
- 2025-12-01: Added an embeddable map/search widget (`sdk/ts/map-widget.ts` + `docs/map-embed.html`) that calls `/search` + `/geojson`, introduced a `make demo` starter (`scripts/demo_starter.sh`) to seed a demo workspace and guide API/console/Chromatic flows, and improved HTTP error messaging in the TS client/frontend to surface structured `detail` fields.
- 2025-12-01: Completed Chromatic wiring for the frontend Storybook (local CLI + CI workflow), documented critical baseline stories (Pipeline/MapControls, ArtifactPanels, Stages, JobsList, UploadSearch) and how to gate merges via Chromatic status checks, and ignored Storybook build artifacts in git.
- 2025-12-01: Added gazetteer-backed place suggestion stub (optional via `PUKAIST_PLACE_SUGGEST_ENABLED`) that writes `geo_suggestions` from text, exposed config envs, tests, and README/plan updates; expanded Playwright coverage (suggestion source/score, KMZ success/error banners).
- 2025-12-01: Added Storybook coverage for the map/KMZ controls (`Pipeline/MapControls` story) to support UI regression without hitting the backend.
- 2025-12-01: Added Playwright coverage for artifact panels (summary/preview/metadata/insights copy/download) to guard the pipeline UI.
- 2025-12-01: Documented a visual regression approach for the map Storybook story (Chromatic/ Percy options) under `frontend/scripts/visual_regression_note.md`.
- 2025-12-01: Added Storybook story for pipeline artifact panels (`Pipeline/ArtifactPanels`) to design/test summary/OCR/metadata/insights layouts without backend data.
- 2025-12-01: Added Storybook stories for pipeline stages and upload/search controls to keep UI pieces modular and visual-testable (`Pipeline/Stages`, `Pipeline/UploadSearch`), and wired Chromatic CLI for future visual baselines; added shared components for stages/artifact panels and a Logs panel (UI + `/logs` API) to tail API/worker logs.
- 2025-12-01: Refactored pipeline UI to use reusable components (stages + artifact panels), added `/logs` API + UI panel, added Playwright coverage for logs tail, Storybook build fixes, and a CI workflow (`.github/workflows/frontend-ui.yml`) that runs E2E + Storybook + Chromatic (when token set).
- 2025-12-01: CI now uploads Playwright artifacts/preview logs to aid diagnosis in GitHub Actions; map controls moved to a reusable component with a Storybook story.
- 2025-12-01: Added shared jobs list component + Storybook story and Playwright test; CI workflow now runs the jobs E2E as part of the suite.
- 2025-12-01: Added CI setup note (`docs/ci-setup.md`) and agents guidance to set `CHROMATIC_PROJECT_TOKEN` for Chromatic uploads in the frontend UI workflow.
- 2025-12-01: Surfaced worker controls/help inside the pipeline view, added structured logging for geo suggestion accept/reject/coord updates and KMZ imports, and marked the geo plan milestones complete.
- 2025-12-01: Added Leaflet-based map editing in the pipeline view (click to add points, drag to move, suggestions list with accept/reject) using new geo_suggestions APIs; geo endpoint now returns coord ids for edits.
- 2025-12-01: Added KMZ/KML import endpoint (`/aoi/import_kmz`) gated by `PUKAIST_KMZ_ENABLED` and a minimal KMZ importer (points → doc geo points, polygons → AOIs); added `fastkml` dependency.
- 2025-12-01: Enhanced map UI with layer toggles (docs/suggestions/AOIs), KMZ/KML/GeoJSON upload from the console (attaches points to the open doc; polygons to AOIs), and AOI rendering; Leaflet remains the map engine.
- 2025-12-01: Added AOI theme filter and KMZ import curl helper in the map UI; KMZ import now accepts GeoJSON; worker helper panel added in the console empty state.
- 2025-12-01: Added geo API tests (suggestions list/accept/reject, coord patch, KMZ/GeoJSON import) and a preview-backed Playwright runner script (`npm run test:e2e:serve`), plus a mocked map interaction test; pytest dependencies installed in local venv.
- 2025-11-30: Added geo suggestions + edit API scaffolding (`geo_suggestions` table, list/accept/reject suggestions, PATCH coords) to support map editing and place suggestions per doc.
- 2025-11-30: Added a doc pipeline view to the frontend (per-doc stage checklist with summary and OCR preview) and a “View pipeline” action from flagged tasks; exposed an API helper `/tasks/{task_id}/doc` and search_index lookup to resolve docs by task for the UI. HunyuanOCR integration remains optional/config-driven.
- 2025-11-30: Extended the pipeline view with metadata/insights panels and wired jobs/tasks to launch the pipeline view (job task lists with “View pipeline” actions), making the end-to-end flow visible from uploads through OCR/summary/geo/insights.
- 2025-11-30: Added artifact download + raw JSON toggle, timelines (task/doc and job/task), and pipeline entry points from jobs/tasks/flagged to aid end-to-end triage in the console; added download buttons on doc cards for staged artifacts.
- 2025-11-30: Polished console UX with queue progress bars, job/task filters, a global activity timeline, and quick artifact downloads on doc cards for better demo appeal.
- 2025-11-30: Added demo preset banner + theme toggle, and “copy curl” for artifacts to make the console more demo-friendly for embeds/light mode.
- 2025-11-30: Added “upload sample text” CTA and sample doc loader in the console to quickly populate the pipeline view for demos without user files.
- 2025-11-30: Added an artifact JSON toggle in the pipeline view so raw payloads can be inspected alongside summary/OCR/metadata/insights.
- 2025-11-30: Added an optional HunyuanOCR backend for image OCR (config via `PUKAIST_OCR_BACKEND=hunyuan` and `PUKAIST_HUNYUAN_OCR_MODEL`), wired through the worker’s `_extract_text` with graceful fallback to pytesseract and updated `.env.example`/LLM ops docs; default behavior remains unchanged unless explicitly enabled.
- 2025-11-30: Added hash-based dedupe with a tenant-aware manifest table and `dedupe`/`enqueue` controls on `/upload` (includes sha256 + manifest_id in responses), updated the TS client to pass query params, enabled role-aware gating + whoami display in the console, and added a dedupe toggle on upload. Sprint plan updated to mark dedupe/role-aware UI done.
- 2025-11-30: Added an offline-friendly local walkthrough script (`scripts/local_walkthrough.sh`) and doc (`docs/local-walkthrough.md`) covering intake-scan → worker → search; upgraded the console with intent controls (allowed_exts, prefilter hints, LLM mode) and client-side extension blocking; marked sprint items complete in `MASTER_PLAN.md`.
- 2025-11-30: Enabled per-upload intent overrides: `/upload` now accepts JSON intent (allowed_exts, prefilter, llm_mode, summary_enabled), stores it with the task, and worker respects it for prefilter and LLM mode; console now sends intent metadata with uploads via the SDK. Added task-level intent column to the queue and schema migration.
- 2025-11-30: Surfaced intent for debugging: `/tasks` and `/tasks/flagged` now decode stored intent, `/docs/{id}/artifact` includes intent from the task (tenant-scoped), and the console shows intent in doc detail to keep UI/back-end aligned for non-hard-coded configurations.
- 2025-11-30: Added a regression test (`tests/test_intent_override.py`) ensuring intent-driven `llm_mode=offline` skips summaries; py_compile checks continue to pass on intent-aware modules.
- 2025-11-30: Extended the TS SDK with flagged-task support and intent typing; console now uses the SDK for flagged tasks while preserving intent display.
- 2025-11-30: Added API-level coverage that flagged tasks include intent and respect tenant scoping (`tests/test_api_flagged_intent.py`), reinforcing the non-hard-coded intent pipeline end-to-end.
- 2025-11-30: Modernized the console ops view with quick intent filters (llm_mode dropdown + text filter) to triage flagged tasks without hard-coding backend rules.
- 2025-11-30: Refreshed console styling with a darker, card-based layout and accent buttons to make the web surface more embed-ready without embedding backend logic.
- 2025-11-30: Added recent-tasks filters in the console (status + theme) using the SDK to keep ops views non-hard-coded and intent-aware.
- 2025-11-30: Improved ops readability with inline task formatter (status/theme/llm/err) while still showing raw JSON, keeping the UI thin but easier to scan.
- 2025-11-30: Added colored chips in the console ops formatter for status to aid quick scanning while preserving raw JSON for debugging.
- 2025-11-30: Added formatted search results (theme/type badges) and chips for doc detail theme/type to modernize the web console without moving business logic client-side.
- 2025-11-30: Added server-side task filters (status/theme/intent substring) for `/tasks` and `/tasks/flagged`, updated the TS SDK to pass filters, and wired the console to use them while keeping intent-aware client filters.
- 2025-11-30: Added API test for task filters (`tests/test_api_tasks_filters.py`) to lock the new query params (status/theme/intent_contains) end-to-end.
- 2025-11-30: Opened a “Next Sprint (Web polish & filters)” section in `MASTER_PLAN.md` to track upcoming UI/filters tasks that keep the console thin but modernized.
- 2025-11-30: Added server-side search/doc filters (theme/doc_type) with SDK and console wiring, plus hybrid search now accepts the same filters; search results remain formatted with badges while logic stays backend-driven.
- 2025-11-30: Added a filtered smoke script (`scripts/smoke_filters.sh`) and referenced it in the walkthrough to exercise `/tasks` and search/doc filters when the API is running.
- 2025-11-30: Tweaked console search formatting to include snippets when available while keeping all logic server-side.
- 2025-11-30: Added search result chips (theme/type/id) for better scanability while keeping computation/server data unchanged.
- 2025-11-30: Minor mobile tweaks to the console layout (stacked header/config, shorter map height) to improve responsiveness without changing logic.
- 2025-11-30: Added API test for search filters (`tests/test_api_search_filters.py`) to ensure theme-based narrowing works under tenant scoping.
- 2025-11-30: Surfaced task status in search/docs results (joined via tasks), updated API model/SDK to carry status, and added status chips to search output while keeping computation server-side.
- 2025-11-30: Added API test for docs filters/status (`tests/test_api_docs_filters_status.py`) to ensure docs responses carry status when filtered.
- 2025-11-30: Added source chips to search results and tightened layout using reusable row styles; UI polish only (logic remains server-side).
- 2025-11-30: Stabilized the frontend console (JS-only, hybrid search handler lives inside the script block, no trailing fragments), added a “Current Sprint (Local realism)” section with concrete checkboxes, split out the upload hash manifest as an explicit TODO, and updated agents guidance to forbid placeholders (except manual LLM tests) while adding a UI regression check. 
- 2025-11-30: Added `PUKAIST_LLM_MODE` config (sync vs batch), updated the worker to skip LLM calls in batch mode, and introduced `src.batch_llm` (JSONL batch preparer + summary ingestor) with index/notebook updates; batch-ready docs are those with `summary` NULL, listable via new helpers in `search_index.py`.
- 2025-11-30: Made LLM limits config-driven via env (`PUKAIST_LLM_INPUT_MAX_CHARS`, `PUKAIST_LLM_MAX_TOKENS`, `PUKAIST_LLM_TEMPERATURE`); wired settings into `LLMClient`/`LLMAdapter` and worker so OpenAI series 5 models (e.g. `gpt-5`, `gpt-5-nano`) can be tuned without code changes.
- 2025-11-30: Updated docker-compose, `.env.example`, README, and `docs/deploy-local.md` to reflect series-5 defaults (model `gpt-5`, base URL `https://api.openai.com`) and new LLM config envs; clarified planning rules in `agents.md` and added roadmap sections for LLM config/testing and batch optimisation in `MASTER_PLAN.md`. Added `docs/llm-ops-and-testing.md` documenting sync vs batch usage, GPT‑5‑nano tuning, and the LLM testing strategy/runbook.
- 2025-11-30: Added `scripts/openai_batch_submit.py` as an optional helper to POST batch JSONL files to an OpenAI-compatible `/v1/batch` endpoint using `PUKAIST_LLM_BASE_URL`/`PUKAIST_LLM_API_KEY`. Enhanced `docs/web-demo.html` with a Bearer-token toggle for OIDC flows and documented a concrete GPT‑5‑nano config example in `docs/llm-ops-and-testing.md`.
- 2025-11-30: Added `sdk/ts/embed-widget.ts` (upload + job status + search panel) and `docs/embed-widget.html` to demonstrate mounting the widget into any page using the TS SDK. Updated `MASTER_PLAN.md` Web Console & Embeds section and README to reference the widget alongside the main web demo.
- 2025-11-30: Initialised a local git repo, added `.gitignore` and an MIT `LICENSE`, and created `docs/web-demo.html` as a minimal browser UI for uploads/search/map integration against the API. Updated `MASTER_PLAN.md` with new future workstreams (Web Console & Embeds, Multi-Tenant & Auth, Scaling & Ops, Domain-Specific Intelligence) and README/agents to reflect the web demo and how to serve it with proper CORS.
- 2025-11-30: Updated `agents.md` with a concrete change checklist (update MASTER_PLAN checkboxes, append ACTION_LOG entries, keep config/LLM docs in sync, and verify web demos) so future work consistently follows the planning/audit process.
- 2025-11-30: Added `docs/multi-tenant-design.md` describing a future tenant-aware data model and scoping rules, plus `PUKAIST_DEFAULT_TENANT`/`PUKAIST_TENANT_CLAIM` placeholders in `.env.example`. Marked the “design multi-tenant data model” checkbox complete in `MASTER_PLAN.md` and pointed `agents.md` at the design doc for future implementation.
- 2025-11-30: Started implementing tenant awareness: added `tenant_id` columns to jobs/tasks/docs/geo_points, wired tenant envs into `Settings`, derived tenant IDs from JWT claims or default in the API, and threaded tenant IDs through upload → queue → worker → index → geo/AOI paths while preserving single-tenant behavior when tenant config is unset. Updated `docs/deploy-local.md` to mention tenant envs and JWKS URL alongside auth settings.
- 2025-11-30: Completed initial multi-tenant auth and docs: added `docs/tenant-onboarding.md` detailing tenant onboarding, JWT issuance, and role considerations; marked the remaining Multi-Tenant & Auth Hardening items as done in `MASTER_PLAN.md`; and pointed `agents.md` at the new onboarding doc for future work.
- 2025-11-30: Documented scaling and ops guidance in `docs/scaling-and-ops.md` (recommended topology, scaling notes, backup/restore, key rotation, and incident response), and marked the corresponding topology/runbook items in the Scaling & Production Ops section of `MASTER_PLAN.md` as complete.
- 2025-11-30: Added env-driven DB and HTTP timeout tuning (`PUKAIST_DB_TIMEOUT_SEC`, `PUKAIST_LLM_HTTP_TIMEOUT_SEC`, `PUKAIST_WEBHOOK_HTTP_TIMEOUT_SEC`, `PUKAIST_JWKS_HTTP_TIMEOUT_SEC`, `PUKAIST_BATCH_HTTP_TIMEOUT_SEC`) and wired them into SQLite connectors, LLM client, JWKS fetch, webhook callbacks, and batch submitter. Updated `.env.example`, `docs/deploy-local.md`, and `MASTER_PLAN.md` to reflect that Scaling & Production Ops timeout configuration is now complete.
- 2025-11-30: Introduced a heuristic `insights` structure computed by the worker (`src/insights.py`) and stored alongside each task's JSON artifact and notebook entry, plus `docs/domain-intelligence.md` describing the shape and future LLM-enhanced extensions. Updated `MASTER_PLAN.md` Domain-Specific Intelligence section and README to reference insights in artifacts.
- 2025-11-30: Improved the web demo UX (`docs/web-demo.html`) with a two-column layout and an Operations panel (jobs, job summaries, job tasks, flagged tasks, queue status) to support operational workflows. Marked the corresponding Web Console & Embeds styling/ops item complete in `MASTER_PLAN.md`.
- 2025-11-30: Added `docs/domain-examples.md` outlining example flows that combine insights, search, notebooks, and map/AOI overlays, and updated `MASTER_PLAN.md` and README to reflect available domain intelligence demos.
- 2025-11-30: Added optional LLM-based classification/extraction prompts to enrich `insights`: `LLMClient.extract_insights` now asks for JSON topics/entities/risks, `LLMAdapter` exposes `extract_insights`, and the worker can merge this under `insights["llm"]` when `PUKAIST_LLM_INSIGHTS_ENABLED=true`. Updated `.env.example`, `docs/llm-ops-and-testing.md`, and `MASTER_PLAN.md` to mark the classification/extraction item complete.
- 2025-11-30: Created `tests/test_multi_tenant.py` with basic checks that jobs/tasks are tagged with the default tenant and that search results are correctly scoped by tenant_id, and added a new Hardening & Tests section to `MASTER_PLAN.md` to track further API-level and batch-related tests.
- 2025-11-30: Added `tests/test_batch_and_llm_insights.py` to exercise the batch JSONL prepare/ingest helpers and verify that LLM insights extraction is correctly skipped when offline is forced; updated the Hardening & Tests section in `MASTER_PLAN.md` to mark the batch/insights test item complete and tightened the existing flagged E2E test to include tenant scoping.
- 2025-11-30: Added `tests/test_api_multi_tenant.py` to cover API-level multi-tenant isolation using unsigned JWTs with tenant claims against `/upload` and `/search`, and marked the corresponding API-level tests item in the Hardening & Tests section of `MASTER_PLAN.md` as complete.
- 2025-11-30: Opened a new Phase 2 section in `MASTER_PLAN.md` (Productization & Scale) to track future work on a dedicated frontend, external DB/storage options, and role-aware auth, and updated `agents.md` with guidance to keep Phase 2 changes aligned with local-first constraints.
- 2025-11-30: Added `docs/persistence-postgres-migration.md` describing a proposed migration path from SQLite to Postgres for queue/jobs/docs while preserving SQLite as the local/dev default, marked the Phase 2 persistence design item as complete in `MASTER_PLAN.md`, and updated `agents.md` with future guidance on using repository abstractions for DB access.
- 2025-11-30: Added `docs/storage-shared-object.md` documenting how to use shared filesystems or object storage for uploads/staging while preserving the logical local layout, marked the Phase 2 storage design item as complete in `MASTER_PLAN.md`, and updated `agents.md` with guidance on future storage backends.
- 2025-11-30: Added `docs/frontend-app-design.md` outlining a dedicated frontend app structure (Upload/Search/Map/Ops views backed by the existing SDK/API) and updated `agents.md` with guidance on treating the frontend as a thin client over the API while keeping business logic on the backend.
- 2025-11-30: Added `docs/roles-and-authz.md` describing a coarse-grained, claim-driven role model (admin/ingest/viewer) for future OIDC/JWT deployments, marked the Phase 2 security/roles item as complete in `MASTER_PLAN.md`, and updated `agents.md` with guidance on keeping role checks simple and endpoint-scoped.
- 2025-11-30: Created `frontend/index.html` as a dedicated "Pukaist Console" app using the TS SDK for uploads, job tracking, search/docs, operations, and map/AOI views, and updated `MASTER_PLAN.md` and README to reflect the new frontend implementation.
- 2025-11-30: Added `docs/local-dev-testing.md` to capture realistic local development goals and offline-friendly test workflows (make api/worker/test, manual console flows, batch and multi-tenant simulations), and referenced it from `MASTER_PLAN.md` and `agents.md` as the guide for real local testing.
- 2025-11-30: Added `scripts/intake_scan.py` plus a Makefile target (`make intake-scan`) and `tests/test_intake_scan.py` to support drop-folder intake workflows: files placed under the incoming directory can be enqueued into the queue with a single command, and the behavior is covered by local tests.
- 2025-11-30: Added a prefilter layer to reduce LLM cost: `src/prefilter.py` with keyword/min-length checks, wired into the worker to skip LLM calls when not needed, new envs (`PUKAIST_PREFILTER_KEYWORDS`, `PUKAIST_PREFILTER_MIN_CHARS`) documented in `.env.example` and `docs/llm-ops-and-testing.md`, a `scripts/prefilter_scan.py` + `make prefilter-scan` helper to preview LLM candidates, frontend map now supports manual geotagging via `POST /docs/{id}/coords`, and the domain examples doc reflects manual point assignment.
- 2025-11-30: Added a project intent/config flow: `scripts/project_config_wizard.py` (`make project-config`) to capture allowed ext/size, prefilter rules, LLM mode/limits, and optional tenant/theme into `projects/<name>.json` (with a round-trip test), plus worker prefilter integration and docs updates (`docs/local-dev-testing.md`) so intake runs can be tailored to user goals and cost limits before LLM calls.
- 2025-11-30: Updated `MASTER_PLAN.md` Phase 2 to include intake cost control, and `agents.md` to codify intake/prefilter guidance (project configs, prefilter scans, drop-folder workflows).
- 2025-11-30: Added OCR and embeddings config toggles (off by default) to `.env.example`, wired an optional OCR path for images into the worker, modernized the frontend console styling with stored API/key/theme settings and client-side theme filtering, and updated docs (`llm-ops-and-testing.md`, README) to reflect OCR/embeddings and prefilter controls.
- 2025-11-30: Added a hybrid search stub (`/search/hybrid`) with embeddings config stubs, a doc artifact endpoint (`/docs/{id}/artifact`) and geo lookup (`/docs/{id}/geo`), and upgraded the frontend console with project config viewing (dropdown/file load), theme/doc_type filters, hybrid search button, and a doc detail panel that auto-zooms to geo coordinates when available.
- 2025-11-30: Implemented embedding storage and cosine scoring for hybrid search (still config-gated/off by default), added embedding storage on ingest when enabled, exposed optional embedding dimension env, and added `/docs/{id}/geo` to fetch per-doc coordinates for UI zooming.
- 2025-11-30: Added optional role-aware config (`PUKAIST_ROLES_CLAIM` and role values), enforced ingest/admin roles on upload when configured, exposed doc geo lookup and artifact endpoints, and enhanced the frontend doc detail panel (structured summary/insights display, project config view, geo zoom). Hybrid search button remains available in the UI; embeddings stay opt-in.
- 2025-11-30: Enabled manual map-based geotagging: added `GET /docs/{doc_id}` and `POST /docs/{doc_id}/coords` to fetch doc details and attach manual points, updated `search_index.get_doc` to include tenant_id, extended `frontend/index.html` so users can enter a doc ID and click the map to assign a point, and updated `docs/domain-examples.md` to include the new workflow.
- 2025-11-30: Extended `MASTER_PLAN.md` and `agents.md` with a dedicated LLM Batch & Cost Optimisation track (config switch for sync vs batch, batch scheduler/ingestor, GPT-5 nano tuning and runbook) to guide future implementation of the Batch API without altering current worker behaviour.
- 2025-11-29: Default LLM config set for OpenAI series (model `gpt-5`, base URL `https://api.openai.com`); still offline-safe unless configured.
- 2025-11-29: Updated LLM client call to chat completions with input trimming and `max_tokens=512` to align with current OpenAI API expectations.
- 2025-11-29: Added optional audit logging (toggle via `PUKAIST_AUDIT_LOG=true`); API/worker logs go to `99_Working_Files/Logs/`. Auth placeholders added in env; optional OIDC/JWKS guard (issuer/audience check) when enabled. Added docx extraction support (via python-docx).
- 2025-11-29: Added OTEL stub (`otel_stub.py`) to prep for future span instrumentation. API metrics track per-endpoint counters/timings; map demo overlays AOIs with points; queue import/rerun helpers (`make queue-import`, `make queue-rerun-flagged`). Worker now emits per-task JSON artifacts in staging and appends markdown summaries to `01_Internal_Reports/Refined_<theme>.md`. API/worker logs write to `99_Working_Files/Logs/`.
- 2025-11-29: Added LLM adapter scaffold (toggleable via env, offline by default; online path uses heuristic summary) and task-duration metrics observation. Added API request logging + metrics middleware (`/metrics` exposes counters/timings). Introduced LLM client placeholder (env-driven provider/model/base URL/API key; falls back to heuristic if not configured).
- 2025-11-29: Added flagged-task visibility (`/tasks/flagged`), job error summaries, structured upload errors, webhook `error_summary`, PDF text extraction, geo regex fix, OpenAPI regen, TS client type sync, and unit/E2E tests (metadata/validation, ingest, flagged case). Venv set up; make targets for api/worker/openapi/test. Map demo and embed examples added. Queue admin export added (`make queue-export-flagged` to TSV) and rerun helper (`make queue-rerun-flagged`). Worker logging standardized; readiness endpoint added; metrics endpoint exposed (`/metrics`). AOI add/list endpoints added (`/aoi`), stored under index dir.
- 2025-11-29: Initial scaffold (API upload/queue/status/search/docs/geojson, worker pipeline, FTS/geo index, job tracking, webhook support, TS client, README/agents/master plan).
- 2025-11-29: Added docker-compose for API+worker, plus `docs/deploy-local.md` for local deployment with shared volumes.
